name: Secret Scanning

on:
  push:
    branches: [ main, develop, security/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scan:
    name: Scan for secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
      
      - name: Scan for high-entropy strings
        run: |
          echo "Scanning for potential secrets with high entropy..."
          
          # Scan for long base64-encoded strings (potential API keys)
          # Note: This may produce false positives with legitimate long strings
          # Review any findings to distinguish between secrets and legitimate data
          if grep -rEn "['\"][A-Za-z0-9+/]{60,}[=]{0,2}['\"]" \
            --include="*.py" \
            --include="*.js" \
            --include="*.ts" \
            --include="*.json" \
            --exclude-dir=".git" \
            --exclude-dir="node_modules" \
            --exclude-dir="venv" \
            --exclude-dir="__pycache__" \
            . ; then
            echo "::warning::Found potential base64-encoded secrets. Please review."
          else
            echo "No suspicious base64 strings found."
          fi
          
      - name: Scan for common secret patterns
        run: |
          echo "Scanning for common secret patterns..."
          
          # Check for common secret variable names with hardcoded values
          PATTERNS=(
            "SUPABASE.*KEY.*=.*['\"][a-zA-Z0-9_.-]{40,}['\"]"
            "service_role.*=.*['\"][a-zA-Z0-9_.-]{40,}['\"]"
            "API.*KEY.*=.*['\"][a-zA-Z0-9]{20,}['\"]"
            "SECRET.*=.*['\"][a-zA-Z0-9]{20,}['\"]"
            "PASSWORD.*=.*['\"][^'\"]{8,}['\"]"
            "TOKEN.*=.*['\"][a-zA-Z0-9]{20,}['\"]"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rEn "$pattern" \
              --include="*.py" \
              --include="*.js" \
              --include="*.ts" \
              --include="*.json" \
              --include="*.yml" \
              --include="*.yaml" \
              --exclude-dir=".git" \
              --exclude-dir="node_modules" \
              --exclude-dir="venv" \
              --exclude-dir="__pycache__" \
              --exclude="*.example" \
              --exclude="secret-scan.yml" \
              . ; then
              echo "::error::Found hardcoded secret pattern: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "::error::Hardcoded secrets detected! Please use environment variables."
            exit 1
          else
            echo "No hardcoded secrets detected."
          fi
          
      - name: Verify .env is gitignored
        run: |
          if grep -q "^\.env$" .gitignore || grep -q "^\.env\.local$" .gitignore; then
            echo "✓ .env files are properly gitignored"
          else
            echo "::error::.env files should be added to .gitignore"
            exit 1
          fi
          
      - name: Check for .env.example
        run: |
          if [ -f ".env.example" ]; then
            echo "✓ .env.example file exists"
            
            # Verify it doesn't contain real secrets
            if grep -qE "['\"][A-Za-z0-9+/]{60,}[=]{0,2}['\"]" .env.example; then
              echo "::error::.env.example appears to contain real secrets!"
              exit 1
            fi
          else
            echo "::warning::.env.example file not found - consider adding one"
          fi
